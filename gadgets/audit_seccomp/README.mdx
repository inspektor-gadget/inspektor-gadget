---
title: audit_seccomp
sidebar_position: 10
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

The audit seccomp gadget provides a stream of events with syscalls that had
their seccomp filters generating an audit log. An audit log can be generated in
one of these two conditions:

* The Seccomp profile has the flag `SECCOMP_FILTER_FLAG_LOG` (currently
  [unsupported by runc](https://github.com/opencontainers/runc/pull/3390)) and
  returns any action other than `SECCOMP_RET_ALLOW`.
* The Seccomp profile does not have the flag `SECCOMP_FILTER_FLAG_LOG` but
  returns `SCMP_ACT_LOG` or `SCMP_ACT_KILL*`.

## Getting started

<Tabs groupId="env">
    <TabItem value="kubectl-gadget" label="kubectl gadget">
        ```bash
        $ kubectl gadget run ghcr.io/inspektor-gadget/gadget/audit_seccomp:latest [flags]
        ```
    </TabItem>

    <TabItem value="ig" label="ig">
        ```bash
        $ sudo ig run ghcr.io/inspektor-gadget/gadget/audit_seccomp:latest [flags]
        ```
    </TabItem>
</Tabs>

## Flags

No flags.

## Guide

First, we need to create a pod / container with a seccomp profile that executes
some fordibben syscalls.

<Tabs groupId="env">
<TabItem value="kubectl-gadget" label="kubectl gadget">

We'll use the [Security Profiles
Operator](https://github.com/kubernetes-sigs/security-profiles-operator) to
handle seccomp profiles, however them can be handled manually as explained in
[Restrict a Container's Syscalls with
seccomp](https://kubernetes.io/docs/tutorials/security/seccomp/)

1. [Install](https://github.com/kubernetes-sigs/security-profiles-operator/blob/main/installation-usage.md#install-operator) the Security Profiles Operator
2. Install a SeccompProfile that logs the `mkdir` and blocks the `unshare` syscalls.

```yaml
# seccompprofile.yaml
apiVersion: security-profiles-operator.x-k8s.io/v1beta1
kind: SeccompProfile
metadata:
  name: log
  annotations:
    description: "Log some syscalls"
spec:
  defaultAction: SCMP_ACT_ALLOW
  syscalls:
  - action: SCMP_ACT_KILL
    names:
    - unshare
  - action: SCMP_ACT_LOG
    names:
    - mkdir
```

```bash
$ kubectl apply -f seccompprofile.yaml
```

3. Start a pod with that SeccompProfile.

```yaml
# mypod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  securityContext:
    seccompProfile:
      type: Localhost
      localhostProfile: operator/default/log.json
  restartPolicy: Never
  containers:
  - name: container1
    image: busybox
    command: ["sh"]
    args: ["-c", "while true ; do mkdir /tmp/dir42 ; unshare -i; sleep 1; done"]
```

```yaml
$ kubectl apply -f mypod.yaml
```

</TabItem>

<TabItem value="ig" label="ig">

* Prepare a Seccomp Profile.

```json
{
  "defaultAction": "SCMP_ACT_ALLOW",
  "syscalls": [
    {
      "action": "SCMP_ACT_KILL",
      "names": [
        "unshare"
      ]
    }
  ]
}
```

Create a container using that profile:

```bash
$ docker run --name test-audit-seccomp -d --security-opt seccomp=profile.json \
  busybox /bin/sh -c 'while true ; do unshare -i; sleep 1 ; done'
```

</TabItem>
</Tabs>

Then, start the audit_seccomp gadget and observe how it logs the `unshare` syscall being denied.

<Tabs groupId="env">
<TabItem value="kubectl-gadget" label="kubectl gadget">

```bash
$ kubectl gadget run audit_seccomp:latest
K8S.NAMESPACE   K8S.PODNAME     K8S.CONTAINERN… COMM          PID     TID      UID      GID CODE      K8S.NO… SYSCALL   TIMESTAMP
default         mypod           container1      mkdir       60482   60482        0        0 …_RET_LOG miniku… SYS_MKDIR 2024-08-05T13:0…
default         mypod           container1      unshare     60483   60483        0        0 …L_THREAD miniku… SYS_UNSH… 2024-08-05T13:0…
default         mypod           container1      mkdir       60553   60553        0        0 …_RET_LOG miniku… SYS_MKDIR 2024-08-05T13:0…
default         mypod           container1      unshare     60554   60554        0        0 …L_THREAD miniku… SYS_UNSH… 2024-08-05T13:0
^C
```

</TabItem>

<TabItem value="ig" label="ig">

```bash
$ sudo -E ig run audit_seccomp:latest
RUNTIME.CONTAINERNAME COMM                  PID         TID         UID         GID CODE          SYSCALL       TIMESTAMP
test-audit-seccomp    unshare            485855      485855           0           0 …_KILL_THREAD SYS_UNSHARE   2024-08-02T17:06:48.761…
test-audit-seccomp    unshare            485865      485865           0           0 …_KILL_THREAD SYS_UNSHARE   2024-08-02T17:06:49.833…
test-audit-seccomp    unshare            485868      485868           0           0 …_KILL_THREAD SYS_UNSHARE   2024-08-02T17:06:50.907…
test-audit-seccomp    unshare            485888      485888           0           0 …_KILL_THREAD SYS_UNSHARE   2024-08-02T17:06:51.980…
^C
```

</TabItem>
</Tabs>

Finally, clean the system:

<Tabs groupId="env">
<TabItem value="kubectl-gadget" label="kubectl gadget">
```bash
$ kubectl delete -f mypod.yaml
$ kubectl delete -f seccompprofile.yaml
```
</TabItem>

<TabItem value="ig" label="ig">
```bash
$ docker rm -f test-trace-bind
```
</TabItem>
</Tabs>
