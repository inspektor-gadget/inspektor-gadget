name: Inspektor Gadget Release
env:
  REGISTRY: ghcr.io
on:
  release:
    types: [published]

permissions: read-all

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      # This is needed by below action used to open PR:
      # https://github.com/peter-evans/create-pull-request#token
      contents: write
      pull-requests: write
      packages: write
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
    - name: Update new version in krew-index
      if: github.repository == 'inspektor-gadget/inspektor-gadget'
      uses: rajatjindal/krew-release-bot@3d9faef30a82761d610544f62afddca00993eef9 # v0.0.47
      with:
        workdir: /home/runner/work/inspektor-gadget/inspektor-gadget
        krew_template_file: .krew.yaml
    - name: Update gadgets' version on artifact hub
      id: bump_gadgets
      if: github.repository == 'inspektor-gadget/inspektor-gadget'
      run: |
        # Get the version without the "v" prefix
        inspektor_gadget_version=$(echo $GITHUB_REF_NAME | tr -d '"v')

        echo "version=${inspektor_gadget_version}" >> $GITHUB_OUTPUT

        DATE="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        for PKGFILE in $(find gadgets/ -name artifacthub-pkg.yml) ; do
            # - The 'createdAt' field identifies the release date. It should not
            #   be changed in between releases.
            # - The 'digest' field is modified to request reindexing from
            #   artifacthub. It is fine to modify it more often.
            sed -i \
                -e "s/^version:.*$/version: ${inspektor_gadget_version}/" \
                -e "s/^createdAt:.*$/createdAt: \"${DATE}\"/" \
                -e "s/^digest:.*$/digest: \"${DATE}\"/" \
                $PKGFILE
        done

        # The following is to support multiline with GITHUB_OUTPUT, see:
        # https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#multiline-strings
        echo "changes<<EOF" >> $GITHUB_OUTPUT
        echo "$(git status --porcelain)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Create PR
      if: ${{ steps.bump_gadgets.outputs.changes != '' }}
      uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Artifact Hub: Update gadgets version to v${{ steps.bump_gadgets.outputs.version }}'
        signoff: true
        branch: 'auto_bump_gadgets_v${{ steps.bump_gadgets.outputs.version }}'
        base: main
        delete-branch: true
        title: 'Artifact Hub: Update gadgets version to v${{ steps.bump_gadgets.outputs.version }}'
        body: |
          Hi.

          We released a new version of Inspektor Gadget [v${{ steps.bump_gadgets.outputs.version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.bump_gadgets.outputs.version }}), so the [official gadgets on Artifact Hub](https://artifacthub.io/packages/search?repo=gadgets) needs to be updated.

          This PR was automatically generated by a CI job:
          * [update-inspektor-gadget-release.yaml](https://github.com/${{ github.repository }}/blob/main/.github/workflows/release.yml)

          This PR will not be automatically merged. Please review, edit and merge as appropriate.

          Checklist:
          - [ ] Check that the [Inspektor Gadget CI](https://github.com/${{ github.repository }}/actions/workflows/inspektor-gadget.yml) completed successfully.
          - [ ] Check that the gadgets OCI images have a new tag with the correct version (v${{ steps.bump_gadgets.outputs.version }}). For example, [gadget/trace_open](https://github.com/${{ github.repository }}/pkgs/container/gadget%2Ftrace_open).
          - [ ] Check the diff of this PR.

          After merging, the Artifact Hub bot will notice the update. It might take 30 minutes.
          Then, the following will be updated:
          https://artifacthub.io/packages/search?repo=gadgets

          In case of problems, please check the logs in the [Artifact Hub control panel](https://artifacthub.io/control-panel).

          Best regards.
    - uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4
    - name: Update latest tag
      env:
        IMAGE_TAG: ${{ github.event.release.tag_name }}
        GADGET_TAG: ${{ github.event.release.tag_name }}
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        LATEST_TAG=$(gh release list --limit 1000 --json tagName | jq -r '.[].tagName' | sort -V | tail -n1)
        echo "LATEST_TAG=$LATEST_TAG, CURRENT_IMAGE_TAG=$IMAGE_TAG"
        if [ "$LATEST_TAG" = "$IMAGE_TAG" ]; then
          make update-latest-tag
        fi
